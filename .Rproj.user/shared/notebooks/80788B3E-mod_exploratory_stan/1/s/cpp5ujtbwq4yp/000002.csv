"0","library(sevcheck); library(magrittr); library(tidyverse); theme_set(theme_bw())"
"0","library(forcats); library(rstan); library(ggmcmc); library(mvtnorm)"
"0","rstan_options(auto_write = TRUE)"
"0","options(mc.cores = parallel::detectCores())"
"0","w_to_eta <- function(w, a=0.95) {"
"0","  eta <- w[-length(w)]"
"0","  eta[eta < 0] <- 0"
"0","  w.pred <- sum((eta<1)*eta + (eta>1))"
"0","  if(w.pred > a) {"
"0","    D.i <- (1 - (1-a)^(w.pred/a)) / w.pred"
"0","    eta <- D.i*eta"
"0","  }"
"0","  return(c(eta, 1-sum(eta)))"
"0","}"
"0","Z_Y_trans <- function(Z.v, g=2) {"
"0","  Z.v[Z.v<0] <- 0"
"0","  Z.l <- length(Z.v) - 1"
"0","  if(Z.v[Z.l]==0) { Z.v[Z.l] <- 0.01 }"
"0","  c((Z.v[1:Z.l]^g)/(1 + sum(Z.v[1:Z.l]^g)),"
"0","    1/(1 + sum(Z.v[1:Z.l]^g)))"
"0","}"
